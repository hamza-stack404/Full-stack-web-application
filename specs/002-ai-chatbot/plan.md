# Implementation Plan: AI Chatbot for Todo Management

**Branch**: `002-ai-chatbot` | **Date**: 2026-01-13 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `specs/002-ai-chatbot/spec.md`

## Summary

Phase III extends the existing Phase II Todo application with a conversational AI interface, enabling users to manage tasks through natural language. The implementation uses OpenAI Agents SDK with MCP (Model Context Protocol) tools that wrap existing Phase II task operations. All conversation state is stored in the database (stateless backend), and the system maintains full backward compatibility with Phase II REST API and web UI.

**Key Technical Approach**:
- MCP tools expose Phase II task operations (add, list, complete, delete, update)
- OpenAI agent orchestrates tool calling based on natural language input
- Conversation and Message models store chat history in PostgreSQL
- ChatKit provides React-based chat UI
- Single POST /api/chat endpoint handles all interactions
- JWT authentication reused from Phase II

## Technical Context

**Language/Version**: Python 3.13+ (backend), TypeScript 5.0+ (frontend)
**Primary Dependencies**: FastAPI, SQLModel, OpenAI Agents SDK, MCP Python SDK, Next.js 16+, OpenAI ChatKit
**Storage**: Neon Serverless PostgreSQL (existing + 2 new tables)
**Testing**: pytest (backend), Jest (frontend)
**Target Platform**: WSL 2 (Ubuntu-22.04) for development, Vercel (frontend), cloud hosting (backend)
**Project Type**: Web application (monorepo with /frontend and /backend)
**Performance Goals**: <3 second chat response time (95th percentile), Phase II endpoints unchanged
**Constraints**: Stateless backend, no conversation state in memory, backward compatibility with Phase II
**Scale/Scope**: 100+ concurrent users, unlimited conversations per user, 50 message context window

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Phase II Checks (Full-Stack Web Application)
*   [x] **Spec-Driven Only**: Is all code generated by the AI agent from a task? - YES, all Phase III code will be task-driven
*   [x] **Agentic Dev Stack**: Does the development follow Specify → Plan → Tasks → Implement? - YES, following workflow
*   [x] **User Isolation**: Is all data access strictly filtered by the authenticated user's ID? - YES, all MCP tools validate user_id
*   [x] **Stateless Architecture**: Does the backend remain stateless? - YES, all state in database
*   [x] **Technology Stack**: Does the implementation adhere to the defined technology stack? - YES, FastAPI + Next.js
*   [x] **Monorepo Structure**: Is the code organized in the specified monorepo structure? - YES, /backend and /frontend
*   [x] **API Standards**: Do all API endpoints follow the defined standards? - YES, /api/chat follows REST conventions
*   [x] **Auth Integration**: Is JWT authentication properly implemented? - YES, reusing Phase II JWT
*   [x] **UI/UX**: Is the UI responsive and free of inline styles? - YES, using ChatKit components

### Phase III Checks (AI Chatbot Extension - if applicable)
*   [x] **Stateless Backend**: Does the server hold NO conversation state in memory? - YES, database-backed only
*   [x] **MCP-Native**: Are task operations exposed as standardized MCP tools? - YES, 5 MCP tools defined
*   [x] **AI-Orchestrated**: Does OpenAI Agents SDK handle tool invocation? - YES, using openai-agents package
*   [x] **Conversation Persistence**: Is all chat history stored in database? - YES, Conversation + Message models
*   [x] **MCP Tool Standards**: Do all tools receive user_id and return structured JSON? - YES, enforced in tool signatures
*   [x] **AI Agent Behavior**: Are responses conversational with proper error handling? - YES, system prompt + error translation
*   [x] **User ID Validation**: Is user_id validation enforced in all MCP tools? - YES, first parameter in all tools
*   [x] **Chat Authentication**: Do all chat endpoints require JWT authentication? - YES, using Phase II auth
*   [x] **Backward Compatibility**: Is Phase II functionality maintained? - YES, no changes to Phase II code
*   [x] **Tool Wrapping**: Do MCP tools wrap existing Phase II functions? - YES, tools call existing CRUD operations

**Gate Status**: ✅ PASSED - All constitution checks satisfied

## Project Structure

### Documentation (this feature)

```text
specs/002-ai-chatbot/
├── spec.md              # Feature specification
├── plan.md              # This file (implementation plan)
├── research.md          # Phase 0 research findings
├── data-model.md        # Database schema design
├── quickstart.md        # Developer setup guide
├── contracts/
│   └── openapi.yml      # API contract specification
└── checklists/
    └── requirements.md  # Specification quality checklist
```

### Source Code (repository root)

```text
backend/
├── src/
│   ├── models.py                    # ADD: Conversation, Message models
│   ├── routes/
│   │   ├── tasks.py                # KEEP: Phase II endpoints (unchanged)
│   │   ├── auth.py                 # KEEP: Phase II auth (unchanged)
│   │   └── chat.py                 # NEW: Chat endpoint
│   ├── services/
│   │   ├── mcp_server.py           # NEW: MCP tools (5 tools)
│   │   └── agent_service.py        # NEW: OpenAI agent integration
│   ├── crud.py                     # KEEP: Phase II task operations (reused by MCP)
│   ├── auth.py                     # KEEP: Phase II JWT validation (reused)
│   └── main.py                     # UPDATE: Register chat router
├── alembic/
│   └── versions/
│       └── 002_add_conversation_tables.py  # NEW: Database migration
├── tests/
│   ├── test_tasks.py               # KEEP: Phase II tests (unchanged)
│   ├── test_mcp_tools.py           # NEW: MCP tool unit tests
│   ├── test_chat_endpoint.py      # NEW: Chat endpoint integration tests
│   └── test_agent_service.py      # NEW: Agent service tests
└── requirements.txt                # UPDATE: Add openai, openai-agents, mcp

frontend/
├── app/
│   ├── tasks/                      # KEEP: Phase II task UI (unchanged)
│   │   └── page.tsx
│   ├── chat/                       # NEW: Chat interface
│   │   └── page.tsx
│   └── layout.tsx                  # UPDATE: Add navigation to chat page
├── lib/
│   ├── api.ts                      # KEEP: Phase II API client (unchanged)
│   └── chat-api.ts                 # NEW: Chat API client
├── components/
│   └── chat/                       # NEW: Chat-specific components
│       ├── ChatInterface.tsx
│       └── MessageList.tsx
└── package.json                    # UPDATE: Add @openai/chatkit

specs/
└── 002-ai-chatbot/                 # This feature's documentation
```

**Structure Decision**: Using existing monorepo structure (Option 2: Web application). Phase III adds new files to backend/frontend without modifying Phase II code, ensuring backward compatibility. MCP tools and agent service are new backend services that wrap existing Phase II CRUD operations.

## Complexity Tracking

> **No violations** - All constitution checks passed without requiring justification.

## Architecture Overview

### System Components

```
┌─────────────────────────────────────────────────────────────────┐
│                         Frontend Layer                          │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐              ┌─────────────────┐          │
│  │  Phase II UI    │              │   ChatKit UI    │          │
│  │  (Existing)     │              │   (New)         │          │
│  │  /tasks         │              │   /chat         │          │
│  └────────┬────────┘              └────────┬────────┘          │
│           │                                │                    │
│           │ JWT                            │ JWT                │
│           ▼                                ▼                    │
└───────────┼────────────────────────────────┼────────────────────┘
            │                                │
┌───────────┼────────────────────────────────┼────────────────────┐
│           │        Backend Layer           │                    │
├───────────┼────────────────────────────────┼────────────────────┤
│           │                                │                    │
│  ┌────────▼────────┐              ┌───────▼────────┐           │
│  │ Phase II REST   │              │ Chat Endpoint  │           │
│  │ /api/tasks      │              │ /api/chat      │           │
│  │ (Existing)      │              │ (New)          │           │
│  └────────┬────────┘              └───────┬────────┘           │
│           │                                │                    │
│           │                                ▼                    │
│           │                       ┌────────────────┐            │
│           │                       │ Agent Service  │            │
│           │                       │ (New)          │            │
│           │                       │ - OpenAI Agent │            │
│           │                       │ - Tool Calling │            │
│           │                       └───────┬────────┘            │
│           │                                │                    │
│           │                                ▼                    │
│           │                       ┌────────────────┐            │
│           │                       │  MCP Server    │            │
│           │                       │  (New)         │            │
│           │                       │  - add_task    │            │
│           │                       │  - list_tasks  │            │
│           │                       │  - complete    │            │
│           │                       │  - delete      │            │
│           │                       │  - update      │            │
│           │                       └───────┬────────┘            │
│           │                                │                    │
│           │                                │ Wraps              │
│           ▼                                ▼                    │
│  ┌────────────────────────────────────────────────┐            │
│  │         Phase II Task CRUD Operations          │            │
│  │         (Existing - Reused)                    │            │
│  └────────────────────┬───────────────────────────┘            │
│                       │                                         │
└───────────────────────┼─────────────────────────────────────────┘
                        │
┌───────────────────────┼─────────────────────────────────────────┐
│                       │    Database Layer                       │
├───────────────────────┼─────────────────────────────────────────┤
│                       ▼                                         │
│  ┌──────────────────────────────────────────────┐              │
│  │         Neon PostgreSQL Database             │              │
│  ├──────────────────────────────────────────────┤              │
│  │  Phase II Tables (Existing):                 │              │
│  │  - users                                     │              │
│  │  - tasks                                     │              │
│  │                                              │              │
│  │  Phase III Tables (New):                    │              │
│  │  - conversations                             │              │
│  │  - messages                                  │              │
│  └──────────────────────────────────────────────┘              │
└─────────────────────────────────────────────────────────────────┘
```

### Data Flow: Chat Request Example

**Scenario**: User types "Add buy groceries"

1. **Frontend** (ChatKit UI):
   - User types message in chat interface
   - ChatKit component captures input
   - Frontend sends POST /api/chat with JWT token

2. **Backend** (Chat Endpoint):
   - Validates JWT token (Phase II auth)
   - Extracts user_id from token claims
   - Gets or creates conversation for user
   - Loads last 50 messages from database
   - Adds user message to history
   - Saves user message to database

3. **Agent Service**:
   - Receives conversation history + new message
   - Sends to OpenAI with system prompt
   - OpenAI analyzes: "User wants to create task"
   - OpenAI decides to call add_task tool

4. **MCP Server**:
   - Receives tool call: add_task(user_id="user123", title="Buy groceries")
   - Validates user_id matches authenticated user
   - Calls existing Phase II create_task function
   - Task created in database (same as Phase II)
   - Returns structured response: {task_id: 42, status: "created", title: "Buy groceries"}

5. **Agent Service**:
   - Receives tool result
   - Generates conversational response: "I've added 'Buy groceries' to your todo list! ✅"
   - Returns to chat endpoint

6. **Backend** (Chat Endpoint):
   - Saves assistant message to database
   - Returns response to frontend
   - **Clears all state** (stateless)

7. **Frontend** (ChatKit UI):
   - Displays assistant response
   - User can verify task in Phase II UI (/tasks)

**Key Points**:
- No server-side state retained
- Phase II task logic reused (no duplication)
- Task visible in both chat and Phase II UI
- Full conversation history in database

## Phase 0: Research Findings

**See**: [research.md](research.md) for complete research documentation

**Key Decisions**:

1. **MCP Integration**: Embedded MCP Python SDK within FastAPI (not standalone server)
2. **AI Agent**: OpenAI Agents SDK with GPT-4 Turbo for tool calling
3. **Conversation Storage**: Database-backed with on-demand loading (stateless)
4. **Frontend UI**: OpenAI ChatKit React components
5. **Authentication**: Reuse Phase II JWT tokens
6. **Tool Design**: User ID as first parameter in all tools
7. **Error Handling**: AI-translated error messages for conversational tone
8. **Performance**: Async I/O, database indexing, 50-message context limit

**Technology Stack Additions**:
- Backend: `openai>=1.10.0`, `openai-agents>=0.1.0`, `mcp>=0.1.0`
- Frontend: `@openai/chatkit>=0.1.0`

## Phase 1: Design Artifacts

### Database Schema

**See**: [data-model.md](data-model.md) for complete schema documentation

**New Tables**:

1. **conversations**
   - `id` (PK, auto-increment)
   - `user_id` (FK → users.id, indexed)
   - `created_at` (datetime)
   - `updated_at` (datetime, indexed)

2. **messages**
   - `id` (PK, auto-increment)
   - `conversation_id` (FK → conversations.id, indexed)
   - `role` (enum: "user" | "assistant")
   - `content` (text)
   - `created_at` (datetime, indexed)

**Relationships**:
- User → Conversations (1:N)
- Conversation → Messages (1:N)
- Tasks remain unchanged (accessed via MCP tools)

**Migration**: Alembic migration script adds tables with indexes

### API Contracts

**See**: [contracts/openapi.yml](contracts/openapi.yml) for complete API specification

**New Endpoints**:

1. **POST /api/chat**
   - Request: `{conversation_id?: int, message: string}`
   - Response: `{conversation_id: int, response: string, tool_calls: string[]}`
   - Auth: JWT Bearer token (Phase II)

2. **GET /api/conversations**
   - Lists user's conversations
   - Response: `{conversations: Conversation[]}`

3. **GET /api/conversations/{id}/messages**
   - Gets conversation message history
   - Response: `{messages: Message[]}`

**Phase II Endpoints**: Unchanged (backward compatibility)

### MCP Tools Specification

**5 Tools** (all wrap Phase II operations):

1. **add_task**(user_id: str, title: str, description?: str) → {task_id, status, title}
2. **list_tasks**(user_id: str, status?: str) → Task[]
3. **complete_task**(user_id: str, task_id: int) → {task_id, status, title}
4. **delete_task**(user_id: str, task_id: int) → {task_id, status, title}
5. **update_task**(user_id: str, task_id: int, title?: str, description?: str) → {task_id, status, title}

**Tool Standards**:
- First parameter always user_id (enforces isolation)
- Return structured JSON (not raw database objects)
- Validate user_id before any operation
- Call existing Phase II CRUD functions (no duplication)

### Agent Configuration

**System Prompt**:
```
You are a helpful todo assistant. Help users manage their tasks using the available tools.
Be conversational and confirm actions. Always use the tools to interact with tasks.
When users ask to create tasks, extract the task title from their message.
When users ask about their tasks, use list_tasks to retrieve them.
Be friendly and use emojis sparingly to acknowledge successful actions.
```

**Model**: GPT-4 Turbo (gpt-4-turbo-preview)
**Tools**: All 5 MCP tools registered
**Context Window**: Last 50 messages

## Implementation Phases

### Phase 2A: Backend Foundation

**Tasks** (will be detailed in tasks.md):
1. Add Conversation and Message models to models.py
2. Create database migration script
3. Run migration to add tables
4. Verify tables and indexes created

### Phase 2B: MCP Tools

**Tasks**:
1. Create mcp_server.py with tool decorators
2. Implement add_task tool (wrap Phase II create_task)
3. Implement list_tasks tool (wrap Phase II get_tasks)
4. Implement complete_task tool (wrap Phase II update_task)
5. Implement delete_task tool (wrap Phase II delete_task)
6. Implement update_task tool (wrap Phase II update_task)
7. Add user_id validation to all tools
8. Write unit tests for each tool

### Phase 2C: Agent Service

**Tasks**:
1. Create agent_service.py
2. Configure OpenAI agent with system prompt
3. Register all MCP tools with agent
4. Implement run_agent function
5. Add error handling and timeout
6. Write unit tests for agent service

### Phase 2D: Chat Endpoint

**Tasks**:
1. Create chat.py router
2. Implement POST /api/chat endpoint
3. Add JWT authentication (reuse Phase II)
4. Implement get_or_create_conversation logic
5. Implement load_conversation_history logic
6. Implement save_message logic
7. Integrate with agent service
8. Add error handling
9. Write integration tests

### Phase 2E: Frontend Chat UI

**Tasks**:
1. Install @openai/chatkit package
2. Create app/chat/page.tsx
3. Implement ChatInterface component
4. Create chat-api.ts client
5. Add JWT token to requests
6. Handle loading and error states
7. Add navigation link to chat page
8. Style chat interface (Tailwind CSS)
9. Write component tests

### Phase 2F: Integration & Testing

**Tasks**:
1. End-to-end test: Create task via chat, verify in Phase II UI
2. End-to-end test: Complete task via chat, verify in Phase II UI
3. End-to-end test: Delete task via chat, verify in Phase II UI
4. Test conversation persistence (refresh page)
5. Test concurrent users
6. Performance test: Measure chat response time
7. Verify Phase II endpoints unchanged
8. Security test: Attempt cross-user access

## Performance Targets

- **Chat Response Time**: <3 seconds (95th percentile)
- **Database Query Time**: <100ms per query
- **OpenAI API Latency**: 1-2 seconds (typical)
- **Phase II Endpoints**: No degradation from baseline
- **Concurrent Users**: Support 100+ simultaneous chat sessions

**Optimization Strategies**:
- Async I/O for all database and API calls
- Database indexes on user_id, conversation_id, created_at
- Limit conversation history to 50 messages
- Connection pooling (existing Phase II config)
- Timeout handling (5 second max)

## Security Considerations

### Authentication & Authorization
- All chat endpoints require Phase II JWT token
- User ID extracted from JWT claims (not request body)
- MCP tools validate user_id matches authenticated user
- Conversation access restricted to owner

### Data Isolation
- Database queries filter by user_id
- Foreign key constraints enforce referential integrity
- No cross-user data access possible
- Audit logging for compliance (future)

### API Security
- OpenAI API key stored in environment variables
- Never exposed to frontend
- Rate limiting on chat endpoint (future)
- Input validation on all requests

## Backward Compatibility

### Phase II Unchanged
- ✅ All Phase II REST endpoints work identically
- ✅ Phase II web UI functions without modification
- ✅ Task model and database schema unchanged
- ✅ Authentication mechanism unchanged
- ✅ No breaking changes to existing APIs

### Integration Points
- MCP tools call existing Phase II CRUD functions
- Chat endpoint reuses Phase II JWT validation
- Database connection pool shared
- Same user isolation rules apply

## Risks & Mitigations

### Risk 1: OpenAI API Latency
**Impact**: May exceed 3-second target
**Probability**: Medium
**Mitigation**: Use GPT-4 Turbo (faster), limit context, implement timeout, monitor latency

### Risk 2: OpenAI API Costs
**Impact**: Operational costs increase with usage
**Probability**: High
**Mitigation**: Monitor usage, implement rate limiting, optimize prompts, consider caching

### Risk 3: Tool Calling Errors
**Impact**: AI may call tools incorrectly or not at all
**Probability**: Medium
**Mitigation**: Clear tool descriptions, validation in tools, comprehensive testing, error handling

### Risk 4: Conversation Context Growth
**Impact**: Large conversations slow responses
**Probability**: Medium
**Mitigation**: Limit to 50 messages, implement pagination, conversation archiving

### Risk 5: Database Performance
**Impact**: Slow queries affect response time
**Probability**: Low
**Mitigation**: Proper indexing, query optimization, connection pooling, monitoring

## Testing Strategy

### Unit Tests
- MCP tool functions (mock Phase II operations)
- Agent service (mock OpenAI API)
- Database models and relationships
- Validation logic

### Integration Tests
- Chat endpoint with real database
- MCP tools with real Phase II functions
- Conversation persistence
- Authentication flow

### End-to-End Tests
- Complete user flows (create, list, complete, delete tasks via chat)
- Verify changes visible in Phase II UI
- Test conversation persistence across sessions
- Multi-user scenarios

### Performance Tests
- Load test with 100 concurrent users
- Measure chat response time distribution
- Database query performance
- OpenAI API latency monitoring

## Deployment Considerations

### Environment Variables
- `OPENAI_API_KEY`: Required for agent service
- `OPENAI_MODEL`: Model name (default: gpt-4-turbo-preview)
- Existing Phase II variables unchanged

### Database Migration
- Run Alembic migration before deployment
- Zero downtime (additive changes only)
- Rollback plan available

### Monitoring
- Chat response time metrics
- OpenAI API usage and costs
- Error rates and types
- Database query performance

## Next Steps

1. **Review this plan** with stakeholders
2. **Run `/sp.tasks`** to generate detailed implementation tasks
3. **Begin Phase 2A** (Backend Foundation)
4. **Iterate through phases** 2B-2F
5. **Deploy to staging** for user acceptance testing
6. **Production deployment** after validation

## References

- **Specification**: [spec.md](spec.md)
- **Research**: [research.md](research.md)
- **Data Model**: [data-model.md](data-model.md)
- **API Contracts**: [contracts/openapi.yml](contracts/openapi.yml)
- **Quickstart Guide**: [quickstart.md](quickstart.md)
- **Constitution**: `.specify/memory/constitution.md`
